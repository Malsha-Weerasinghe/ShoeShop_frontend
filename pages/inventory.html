<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <title>Item Information</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url("../assets/images/stockists-mobile.webp");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      padding: 20px;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.2); /* Adjust the alpha value (0-1) for desired opacity */
      z-index: -1; /* Ensure the overlay is behind the content */
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    form {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }
    label {
      font-weight: bold;
    }
    input, select {
      width: calc(100% - 22px);
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      /*width: 100%;*/
      padding: 10px;
      background-color: #0eba33;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #093b11;
    }
  /*  table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      padding-right: 60px;
      background-color: white;
      margin-left: -100px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #dddddd;
    }
    th {
      background-color: #DAA520;
      color: #fff;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      padding-right: 60px;
      background-color: white;
      table-layout: fixed; /* Ensures the columns have a fixed width */
      margin-left: -200px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #dddddd;
      word-wrap: break-word; /* Allows text to wrap within the cell */
    }

    th {
      background-color: #DAA520;
      color: #fff;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    /* Set a fixed width for each column */
    th, td {
      width: 100px; /* 100% / 13 columns = 7.69% per column */
    }

    th:nth-child(3), td:nth-child(3) {
      width: 100px; /* Set a specific width for the Item Picture column */
      overflow: hidden;
      white-space: nowrap; /* Prevents text from wrapping */
      text-overflow: ellipsis; /* Displays ellipsis (...) for overflow text */
      position: relative; /* Needed for the tooltip */
    }

    /* Tooltip styling */
    td:nth-child(3):hover::after {
      content: attr(data-fulltext); /* Display the full text from a data attribute */
      position: absolute;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      white-space: normal; /* Allows the text to wrap */
      z-index: 10;
      max-width: 300px; /* Max width of the tooltip */
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      top: 100%;
      left: 0;
    }

    .backBtn {
      position: fixed; /* Set position to fixed */
      top: 20px; /* Adjust top position */
      left: 20px; /* Adjust left position */
      width: 50px;
      height: auto;
      border: 2px solid #090808;
      background-color: rgba(255, 255, 255, 0.5);
      border-radius: 10px;
      overflow: hidden;
      text-align: center;
      transition: transform 0.3s ease; /* Add transition effect */
    }

    .backBtn:hover {
      transform: scale(1.1); /* Increase size on hover */
    }

    .backBtn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Item Information Form</h2>
  <div class="backBtn" onclick="goBack()">
    <img src="../assets/images/back.png" alt="Image">
  </div>
  <div class="container mt-5 mb-5"> <!-- Added mb-5 for bottom margin -->
    <div class="row">
      <div class="col-md-6">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Enter Item ID" aria-label="Enter Customer ID" aria-describedby="search-button">
          <div class="input-group-append">
            <button class="btn btn-primary" type="button" id="search-button">Search</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <form id="itemForm" >
    <label for="item_code">Item Code</label>
    <input type="text" id="item_code" name="item_code" required>

    <label for="itemDescription">Item Description</label>
    <input type="text" id="itemDescription" name="itemDescription" required>

    <!--<label for="itemPic">Item Picture (Base64)</label>
    <input type="file" id="itemPic" name="itemPic">-->

    <label for="itemPic">Item Picture (Base64)</label>
    <input type="file" id="itemPic" name="itemPic" accept="image/*">
    <img id="itemPicDisplay" src="" alt="Selected Image" style="max-width: 200px; max-height: 200px;">

    </br>
    <label for="category">Category</label>
    <input type="text" id="category" name="category">

    <label for="size">Size</label>
    <input type="text" id="size" name="size">

    <label for="supplierCode">Supplier Code</label>
    <input type="text" id="supplierCode" name="supplierCode">

    <label for="supplierName">Supplier Name</label>
    <input type="text" id="supplierName" name="supplierName">

    <label for="unitPriceSale">Unit Price (Sale)</label>
    <input type="text" id="unitPriceSale" name="unitPriceSale" step="0.01">

    <label for="unitPriceBuy">Unit Price (Buy)</label>
    <input type="text" id="unitPriceBuy" name="unitPriceBuy" step="0.01">

    <label for="qty">Quantity</label>
    <input type="text" id="qty" name="qty" required>

    <label for="expectedProfit">Expected Profit</label>
    <input type="text" id="expectedProfit" name="expectedProfit" step="0.01">

    <label for="profitMargin">Profit Margin (%)</label>
    <input type="text" id="profitMargin" name="profitMargin" step="0.01">

    <label for="status">Status</label>
    <select id="status" name="status">
      <option value="Select">Select</option>
      <option value="LOW">LOW</option>
      <option value="AVAILABLE">AVAILABLE</option>
      <option value="NOT_AVAILABLE">NOT_AVAILABLE</option>
    </select>

    <button type="button" class="btn btn-success" id="btnAddItem">Save</button>
    <button type="button" class="btn btn-danger" id="btnDeleteItem">Delete</button>
    <button type="button" class="btn btn-warning" id="btnUpdateItem">Update</button>
    <button type="button" class="btn btn-success" id="clearButton">Clear All</button>
  </form>

  <h2>Item Information Table</h2>
  <table>
    <thead>
    <tr>
      <th>Item Code</th>
      <th>Item Description</th>
      <th>Item Picture</th>
      <th>Category</th>
      <th>Size</th>
      <th>Supplier Code</th>
      <th>Supplier Name</th>
      <th>Unit Price (Sale)</th>
      <th>Unit Price (Buy)</th>
      <th>Quantity</th>
      <th>Expected Profit</th>
      <th>Profit Margin (%)</th>
      <th>Status</th>
    </tr>
    </thead>
    <tbody id="inventoryTable">
    <!-- Item data will be populated here -->
    </tbody>
  </table>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="../assets/bootstrap/js/jquery-3.7.1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  function goBack() {
    window.history.back();
  }

  getAllItems();

  /*get all*/
  function getAllItems() {
    $.ajax({
      url: "http://localhost:8080/inventory/getAllItems",
      method: "GET",
      dataType: "json",
      success: function (response) {
        console.log(response);
        console.log(response.length);
        loadItemDataInTable(response);
        generateItemID();
      },
      error: function (xhr, status, err) {
        console.log(err)
      }
    })
  }

  function loadItemDataInTable(items) {
    var tableBody = document.getElementById("inventoryTable");
    tableBody.innerHTML = "";

    items.forEach(function(item) {
      var row = document.createElement("tr");

      ["item_code", "itemDescription", "itemPic","category", "size", "supplierCode", "supplierName", "unitPriceSale",
        "unitPriceBuy","qty", "expectedProfit","profitMargin","status"].forEach(function(property) {
        var cell = document.createElement("td");
        cell.textContent = item[property];
        row.appendChild(cell);
      });
      tableBody.appendChild(row);
    });
  }
  $("#btnAddItem").click(function (){
    saveItem();
  })

  /*save*/
  document.getElementById('itemPic').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
      const base64String = e.target.result.split(',')[1]; // Get base64 string without metadata
      document.getElementById('itemPicDisplay').src = e.target.result; // Display the image
      document.getElementById('itemPic').setAttribute('data-base64', base64String); // Store base64 string in a data attribute
    };

    if (file) {
      reader.readAsDataURL(file); // Convert the image file to base64
    }
  });

  function saveItem() {
    const item_code = document.getElementById('item_code').value;
    const itemDescription = document.getElementById('itemDescription').value;
    const itemPicBase64 = document.getElementById('itemPic').getAttribute('data-base64'); // Get base64 string from data attribute
    const category = document.getElementById('category').value;
    const size = document.getElementById('size').value;
    const supplierCode = document.getElementById('supplierCode').value;
    const supplierName = document.getElementById('supplierName').value;
    const unitPriceSale = document.getElementById('unitPriceSale').value;
    const unitPriceBuy = document.getElementById('unitPriceBuy').value;
    const qty = document.getElementById('qty').value;
    const expectedProfit = document.getElementById('expectedProfit').value;
    const profitMargin = document.getElementById('profitMargin').value;
    const status = document.getElementById('status').value;

    const item = {
      item_code: item_code,
      itemDescription: itemDescription,
      itemPic: itemPicBase64, // Use the base64 string here
      category: category,
      size: size,
      supplierCode: supplierCode,
      supplierName: supplierName,
      unitPriceSale: unitPriceSale,
      unitPriceBuy: unitPriceBuy,
      qty: qty,
      expectedProfit: expectedProfit,
      profitMargin: profitMargin,
      status: status
    };

    $.ajax({
      url: 'http://localhost:8080/inventory/save',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(item),
      success: function(response) {
        console.log(response);
        alert('Item information saved successfully!');
        getAllItems();
      },
      error: function(xhr, status, error) {
        console.error(error);
        alert('Failed to save item information. Please try again.');
      }
    });
  }



  $("#btnUpdateItem").click(function (){
    updateItem();
  })

  /*save*/
  document.getElementById('itemPic').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
      const base64String = e.target.result.split(',')[1]; // Get base64 string without metadata
      document.getElementById('itemPicDisplay').src = e.target.result; // Display the image
      document.getElementById('itemPic').setAttribute('data-base64', base64String); // Store base64 string in a data attribute
    };

    if (file) {
      reader.readAsDataURL(file); // Convert the image file to base64
    }
  });

  function updateItem() {
    const item_code = document.getElementById('item_code').value;
    const itemDescription = document.getElementById('itemDescription').value;
    const itemPicBase64 = document.getElementById('itemPic').getAttribute('data-base64'); // Get base64 string from data attribute
    const category = document.getElementById('category').value;
    const size = document.getElementById('size').value;
    const supplierCode = document.getElementById('supplierCode').value;
    const supplierName = document.getElementById('supplierName').value;
    const unitPriceSale = document.getElementById('unitPriceSale').value;
    const unitPriceBuy = document.getElementById('unitPriceBuy').value;
    const qty = document.getElementById('qty').value;
    const expectedProfit = document.getElementById('expectedProfit').value;
    const profitMargin = document.getElementById('profitMargin').value;
    const status = document.getElementById('status').value;

    const item = {
      item_code: item_code,
      itemDescription: itemDescription,
      itemPic: itemPicBase64, // Use the base64 string here
      category: category,
      size: size,
      supplierCode: supplierCode,
      supplierName: supplierName,
      unitPriceSale: unitPriceSale,
      unitPriceBuy: unitPriceBuy,
      qty: qty,
      expectedProfit: expectedProfit,
      profitMargin: profitMargin,
      status: status
    };

    $.ajax({
      url: 'http://localhost:8080/inventory/update',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(item),
      success: function (response) {
        console.log(response);
        alert('Item information Updated successfully!');
        getAllItems();

      },
      error: function (xhr, status, error) {
        console.error(error);
        alert('Failed to update item information. Please try again.');
      }
    });
  }

  $(document).ready(function() {
    $('#inventoryTable').on('click', 'tr', function() {
      var item_code = $(this).find('td:eq(0)').text();
      var itemDescription = $(this).find('td:eq(1)').text();
      var itemPicData = $(this).find('td:eq(2)').text(); // Assuming this is the Base64 encoded image data
      var category = $(this).find('td:eq(3)').text();
      var size = $(this).find('td:eq(4)').text();
      var supplierCode = $(this).find('td:eq(5)').text();
      var supplierName = $(this).find('td:eq(6)').text();
      var unitPriceSale = $(this).find('td:eq(7)').text();
      var unitPriceBuy = $(this).find('td:eq(8)').text();
      var qty = $(this).find('td:eq(9)').text();
      var expectedProfit = $(this).find('td:eq(10)').text();
      var profitMargin = $(this).find('td:eq(11)').text();
      var status = $(this).find('td:eq(12)').text();

      // Set values to input fields
      $("#item_code").val(item_code);
      $("#itemDescription").val(itemDescription);
      $("#category").val(category);
      $("#size").val(size);
      $("#supplierCode").val(supplierCode);
      $("#supplierName").val(supplierName);
      $("#unitPriceSale").val(unitPriceSale);
      $("#unitPriceBuy").val(unitPriceBuy);
      $("#qty").val(qty);
      $("#expectedProfit").val(expectedProfit);
      $("#profitMargin").val(profitMargin);
      $("#status").val(status);

      // Display the image
      if (itemPicData) {
        // Decode Base64 and set as source
        $("#itemPicDisplay").attr("src", "data:image/jpeg;base64," + itemPicData);
      } else {
        $("#itemPicDisplay").attr("src", ""); // Clear image source
      }
    });

    // Handle file input change to display the selected image
    $('#itemPic').on('change', function(event) {
      var reader = new FileReader();
      reader.onload = function(e) {
        $('#itemPicDisplay').attr('src', e.target.result);
      }
      reader.readAsDataURL(event.target.files[0]);
    });
  });

  $(document).ready(function () {
    getAllItems();

    $('#btnDeleteItem').on('click', function() {
      var item_code = $('#item_code').val();
      if (item_code !== "") {
        deleteItem(item_code);
      } else {
        alert("Please select a customer to delete.");
      }
    });
  });

  /*delete customer*/
  function deleteItem(item_code) {
    $.ajax({
      url: `http://localhost:8080/inventory/delete/${item_code}`,
      type: 'DELETE',
      success: function (response) {
        console.log(response);
        alert('Item deleted successfully!');
        getAllItems();
      },
      error: function (xhr, status, error) {
        console.error(error);
        alert('Failed to delete Item. Please try again.');
      }
    });
  }


  /* $("#btnItemSearch").on("click", function () {
     var search = $("#searchInput").val();
     $("#inventoryTable").empty();

     $.ajax({
       url: 'http://localhost:8080/app/api/v1/inventories/search?id' +id,
       method: "GET",
       data: { id: search },
       contentType: "application/json",
       dataType: "json",
       success: function (res) {
         console.log(res);
         if (res && res.length > 0) {
           // Assuming res is an array of objects
           let firstItem = res[0]; // Assuming you only want details of the first item

           let row = "<tr><td>" + firstItem.itemCode + "</td><td>" + firstItem.itemDesc + "</td><td>" + firstItem.itemPicture + "</td><td>" + firstItem.category + "</td><td>" + firstItem.size + "</td><td>" + firstItem.quantity +
                   "</td><td>" + firstItem.supplierCode + "</td><td>" + firstItem.supplierName + "</td><td>" + firstItem.unitPriceSale + "</td><td>" + firstItem.unitPriceBuy + "</td><td>" + firstItem.expectProfit + "</td>" +
                   "<td>" + firstItem.profitMargin + "</td><td>" + firstItem.status + "</td></tr>";

           // Insert the row before any existing rows
           $("#inventoryTable").append(row);

           // If you want to display other items as well, you can loop through the remaining items and append them to the table
           for (let i = 1; i < res.length; i++) {
             let currentItem = res[i];
             let itemRow = "<tr><td>" + currentItem.itemCode + "</td><td>" + currentItem.itemDesc + "</td><td>" + currentItem.itemPicture + "</td><td>" + currentItem.category + "</td><td>" + currentItem.size + "</td><td>" + currentItem.quantity +
                     "</td><td>" + currentItem.supplierCode + "</td><td>" + currentItem.supplierName + "</td><td>" + currentItem.unitPriceSale + "</td><td>" + currentItem.unitPriceBuy + "</td><td>" + currentItem.expectProfit + "</td>" +
                     "<td>" + currentItem.profitMargin + "</td><td>" + currentItem.status + "</td></tr>";

             $("#inventoryTable").append(itemRow);
           }
         } else {
           console.log("No data found");
           alert("No Data Found")
           // Display a message to the user
           $("#inventoryTable").append("<tr><td colspan='13'>No data found</td></tr>");
         }
       },
       error: function (error) {
         console.error(error);
         alert('Failed to search for items. Please try again.');
       }
     });
   });

   $(document).ready(function () {
     getAllItems();
   });*/


  function generateItemID() {
    $("#item_code").val("I00-001");
    $.ajax({
      url: "http://localhost:8080/inventory/InventoryIdGenerate",
      method: "GET",
      contentType: "application/json",
      dataType: "json",
      success: function (resp) {
        let id = resp.value;
        console.log("id" +id);

        if (id === null){
          $("#item_code").val("I00-001" );
        } else {
          let tempId = parseInt(id.split("-")[1]);
          tempId = tempId + 1;
          if (tempId <= 9) {
            $("#item_code").val("I00-00" + tempId);
          } else if (tempId <= 99) {
            $("#item_code").val("I00-0" + tempId);
          } else {
            $("#item_code").val("I00-" + tempId);
          }
        }
      },
      error: function (ob, statusText, error) {

      }
    });
  }

  $(document).ready(function () {
    getAllItems();
  });

  function customerCapitalizeFirstLetter(str) {
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  }

  function clearInputs() {
    document.getElementById("item_code").value = "";
    document.getElementById("itemDescription").value = "";
    document.getElementById("itemPic").value = "";
    document.getElementById("itemPicDisplay").src = "";
    document.getElementById("category").value = "";
    document.getElementById("size").value = "";
    document.getElementById("supplierCode").value = "";
    document.getElementById("supplierName").value = "";
    document.getElementById("unitPriceSale").value = "";
    document.getElementById("unitPriceBuy").value = "";
    document.getElementById("qty").value = "";
    document.getElementById("expectedProfit").value = "";
    document.getElementById("profitMargin").value = "";
    document.getElementById("status").value = "Select";
    generateItemID();
  }

  // Event listener for the clear button
  document.getElementById("clearButton").addEventListener("click", clearInputs);

</script>
</body>
</html>
